<%- include('partials/header_sidebar') %>

<div class="content-wrapper">
    <div class="container mt-4 mb-5" style="max-width: 1000px;">
        
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="/details/<%= room.hostel_id %>" class="btn btn-outline-dark rounded-pill px-4 shadow-sm">
                    <i class="bi bi-arrow-left"></i> Back to Hostel
                </a>
            </div>
            <% if (user && user.role === 'owner') { %>
                <span class="badge bg-primary rounded-pill px-3 py-2">Owner View</span>
            <% } %>
        </div>

        <!-- Main Content Card -->
        <div class="card border-0 shadow-sm p-4 mb-4">
            <div class="row g-4">
                
                <!-- Left Column: Image Carousel -->
                <div class="col-lg-7">
                    <style>
                        /* Carousel nav button styles (match details page) */
                        .nav-btn-glass {
                            background: rgba(255, 255, 255, 0.9);
                            border: 1px solid rgba(0,0,0,0.08);
                            color: #333;
                            transition: all 0.2s;
                            backdrop-filter: blur(6px);
                        }
                        .nav-btn-glass:hover { background: #D4AF37; color: white; border-color: #D4AF37; }
                        .indicator-dot { transition: all 0.25s ease; }
                    </style>

                    <div id="roomDetailCarousel" class="h-100 position-relative">
                        <div class="carousel-inner rounded-3 shadow-sm h-100 position-relative">
                            <% if(room.images && room.images.length > 0) { %>
                                <% room.images.forEach(function(img, i){ %>
                                    <div class="carousel-item h-100 <%= i===0 ? 'active' : '' %>">
                                        <img src="/uploads/<%= img.image_path %>" class="d-block w-100 h-100" style="object-fit: cover; min-height: 400px;">
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <div class="carousel-item active h-100">
                                    <img src="https://via.placeholder.com/600x400?text=No+Room+Image" class="d-block w-100 h-100" style="object-fit: cover; min-height: 400px;">
                                </div>
                            <% } %>
                        </div>

                        <% if(room.images && room.images.length > 1) { %>
                            <!-- Custom Arrows -->
                            <button onclick="roomMoveSlide(-1)" aria-label="Previous image" class="position-absolute start-0 top-50 translate-middle-y ms-3 w-10 h-10 rounded-circle nav-btn-glass d-flex align-items-center justify-content-center shadow z-20">
                                <i class="bi bi-chevron-left fs-5"></i>
                            </button>
                            <button onclick="roomMoveSlide(1)" aria-label="Next image" class="position-absolute end-0 top-50 translate-middle-y me-3 w-10 h-10 rounded-circle nav-btn-glass d-flex align-items-center justify-content-center shadow z-20">
                                <i class="bi bi-chevron-right fs-5"></i>
                            </button>

                            <!-- Indicators -->
                            <div class="position-absolute bottom-3 start-50 translate-middle-x d-flex gap-2 z-20">
                                <% for(let i = 0; i < room.images.length; i++) { %>
                                    <button onclick="roomGoToSlide(<%= i %>)" class="indicator-dot rounded-circle <%= i===0 ? 'bg-primary' : 'bg-white/70' %>" style="width:8px; height:8px; border:none;"></button>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Right Column: Details & Booking -->
                <div class="col-lg-5">
                    <div class="ps-lg-3">
                        <h2 class="fw-bold mb-1" style="font-family: 'Cinzel';"><%= room.name %></h2>
                        <p class="text-muted small mb-4">
                            <i class="bi bi-building"></i> Part of: <a href="/details/<%= room.hostel_id %>" class="text-decoration-none fw-bold text-dark"><%= hostel.name %></a>
                        </p>
                        
                        <!-- Price Card -->
                        <div class="bg-light p-3 rounded-3 border mb-4">
                            <h6 class="text-muted text-uppercase small ls-1 mb-1">Monthly Rent Per Seat</h6>
                            <h2 class="fw-bold text-success mb-0" id="roomDisplayPrice">
                                Rs. <%= Number(room.price_per_seat).toLocaleString() %>
                            </h2>
                        </div>

                        <!-- Mess Toggle Option (Feature Integrated) -->
                        <% if (hostel.mess_fee > 0) { %>
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body p-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="roomMessToggle" onchange="updateRoomPrice()">
                                        <label class="form-check-label fw-bold text-dark" for="roomMessToggle">
                                            Include Mess / Food
                                            <span class="d-block small text-muted font-monospace">
                                                + Rs. <%= Number(hostel.mess_fee).toLocaleString() %> / month
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        <% } %>

                        <h5 class="fw-bold text-dark border-start border-4 border-warning ps-3 mb-3">Room Details</h5>
                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted"><i class="bi bi-people-fill me-2"></i>Total Capacity</span>
                                <span class="fw-bold"><%= room.total_seats %> Seats</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted"><i class="bi bi-check-circle-fill me-2 text-success"></i>Availability</span>
                                <% if(room.available > 0) { %>
                                    <span class="badge bg-success"><%= room.available %> Seats Left</span>
                                <% } else { %>
                                    <span class="badge bg-danger">Fully Booked</span>
                                <% } %>
                            </li>
                        </ul>
                        
                        <!-- Description -->
                        <div class="mb-4">
                            <p class="text-secondary small"><%= room.description || 'No detailed description provided for this room.' %></p>
                        </div>

                        <!-- Action Button (Booking Logic Integrated) -->
                        <% if (user && user.role === 'student') { %>
                            <form action="/book_seat" method="POST">
                                <input type="hidden" name="room_id" value="<%= room.id %>">
                                <!-- Hidden input to store mess selection -->
                                <input type="hidden" name="with_mess" id="formRoomMessInput">
                                
                                <button type="submit" class="btn btn-gold w-100 py-3 fw-bold shadow-sm" 
                                    <%= room.available <= 0 ? 'disabled' : '' %> 
                                    onclick="setFormMessValue()">
                                    <% if(room.available > 0) { %>
                                        <i class="bi bi-bookmark-check-fill me-1"></i> Reserve Seat Now
                                    <% } else { %>
                                        <i class="bi bi-x-circle me-1"></i> Room Full
                                    <% } %>
                                </button>
                            </form>
                        <% } else if (user && user.role === 'owner') { %>
                             <div class="alert alert-info text-center small"><i class="bi bi-info-circle-fill"></i> You are viewing your own property.</div>
                             <a href="/owner_dashboard" class="btn btn-dark w-100">Go to Dashboard</a>
                        <% } else { %>
                            <a href="/login" class="btn btn-gold w-100 py-3 fw-bold shadow-sm">
                                <i class="bi bi-box-arrow-in-right me-1"></i> Login to Reserve
                            </a>
                        <% } %>

                    </div>
                </div>
            </div>
        </div>

        <!-- Facilities Section -->
        <div class="card border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-stars text-gold" style="color: #D4AF37;"></i> Hostel-Wide Facilities</h5>
            <div class="d-flex flex-wrap gap-2">
                <% if(hostel.facilities) { 
                    hostel.facilities.split(',').forEach(f => { %>
                        <span class="badge bg-light text-dark border p-2 fw-normal">
                            <i class="bi bi-check2-circle text-success me-1"></i> <%= f %>
                        </span>
                <% }); } else { %>
                    <p class="text-muted small mb-0">No specific facilities listed.</p>
                <% } %>
            </div>
        </div>

    </div>
</div>

<!-- Functional Logic Script -->
<script>
    const roomBasePrice = <%= room.price_per_seat %>;
    const roomMessFee = <%= hostel.mess_fee || 0 %>;

    function updateRoomPrice() {
        const toggle = document.getElementById('roomMessToggle');
        const display = document.getElementById('roomDisplayPrice');
        
        let total = roomBasePrice;
        if(toggle && toggle.checked) {
            total += roomMessFee;
            // Change color to warning to visually indicate price increase
            display.classList.add('text-warning');
            display.classList.remove('text-success');
        } else {
            // Revert to default success green
            display.classList.add('text-success');
            display.classList.remove('text-warning');
        }
        display.innerText = "Rs. " + total.toLocaleString();
    }

    function setFormMessValue() {
        const toggle = document.getElementById('roomMessToggle');
        const input = document.getElementById('formRoomMessInput');
        // Set hidden input value based on toggle state before form submission
        input.value = (toggle && toggle.checked) ? 'on' : 'off';
    }

    // --- Room carousel custom controls (match details page) ---
    (function(){
        const carousel = document.getElementById('roomDetailCarousel');
        const slides = carousel ? carousel.querySelectorAll('.carousel-item') : [];
        const indicators = carousel ? carousel.querySelectorAll('.indicator-dot') : [];
        let current = 0;
        const total = slides.length;

        function show(index) {
            if (total === 0) return;
            slides[current].classList.remove('active');
            if (indicators && indicators[current]) {
                indicators[current].classList.remove('bg-primary');
                indicators[current].classList.add('bg-white/70');
            }
            current = index;
            slides[current].classList.add('active');
            if (indicators && indicators[current]) {
                indicators[current].classList.remove('bg-white/70');
                indicators[current].classList.add('bg-primary');
            }
        }

        // expose functions to global scope for onclick handlers
        window.roomMoveSlide = function(dir) {
            if (total === 0) return;
            show((current + dir + total) % total);
            resetRoomAuto();
        };

        window.roomGoToSlide = function(i) {
            if (total === 0) return;
            show(i % total);
            resetRoomAuto();
        };

        // Auto advance
        let roomTimer;
        function roomAuto() {
            if (total > 1) roomTimer = setInterval(() => window.roomMoveSlide(1), 5000);
        }
        function resetRoomAuto() { clearInterval(roomTimer); roomAuto(); }
        roomAuto();

        // Keyboard navigation
        document.addEventListener('keydown', function(e){
            if (e.key === 'ArrowLeft') window.roomMoveSlide(-1);
            if (e.key === 'ArrowRight') window.roomMoveSlide(1);
        });

        // Touch swipe
        (function(){
            let startX = null;
            if (!carousel) return;
            carousel.addEventListener('touchstart', function(e){ startX = e.changedTouches[0].screenX; }, {passive:true});
            carousel.addEventListener('touchend', function(e){
                if (startX === null) return;
                const endX = e.changedTouches[0].screenX; const diff = endX - startX;
                if (Math.abs(diff) > 40) { if (diff > 0) window.roomMoveSlide(-1); else window.roomMoveSlide(1); }
                startX = null;
            }, {passive:true});
        })();
    })();
</script>

<%- include('partials/footer') %>