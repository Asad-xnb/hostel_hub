<%- include('partials/header_sidebar') %>

<style>
    /* --- CUSTOM STYLES --- */
    
    /* Booking Card */
    .booking-card {
        border: none; border-radius: 15px; background: #fff;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        transition: all 0.3s ease; overflow: hidden;
        position: relative;
    }
    .booking-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(212, 175, 55, 0.15); }
    .booking-status-bar { height: 5px; width: 100%; }
    .status-approved { background-color: #2ecc71; }
    .status-pending { background-color: #f1c40f; }
    .status-rejected { background-color: #e74c3c; }

    /* Action Buttons */
    .btn-action-group {
        background: #f8f9fa; padding: 10px; border-radius: 10px;
        display: flex; gap: 10px; justify-content: flex-end;
        flex-wrap: wrap;
    }
    .btn-custom {
        border: 1px solid rgba(0,0,0,0.1); border-radius: 50px;
        font-size: 0.8rem; font-weight: 600; padding: 8px 20px;
        display: flex; align-items: center; gap: 6px; transition: 0.2s;
    }
    .btn-custom:hover { transform: scale(1.05); }
    
    /* Tabs Styling */
    .nav-pills .nav-link {
        color: #555; font-weight: 600; border-radius: 50px; padding: 10px 25px;
        transition: 0.3s; border: 1px solid transparent;
    }
    .nav-pills .nav-link.active {
        background-color: #1a1a1a; color: #D4AF37;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .nav-pills .nav-link:hover:not(.active) { background-color: #f0f0f0; }

    /* Complaint Ticket Style */
    .ticket-card {
        border-left: 4px solid #ddd; background: #fff;
        padding: 20px; border-radius: 0 10px 10px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px;
    }
    .ticket-card.resolved { border-left-color: #2ecc71; }
    .ticket-card.pending { border-left-color: #e74c3c; }

    /* Mobile Responsiveness */
    @media (max-width: 767.98px) {
        .d-flex.justify-content-between.align-items-center.mb-5 {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        .nav-pills {
            flex-wrap: wrap;
            gap: 8px;
        }
        .nav-pills .nav-link {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        .booking-card {
            border-radius: 12px;
        }
        .booking-card p-4 {
            padding: 12px !important;
        }
        .btn-action-group {
            flex-direction: column;
            gap: 8px;
            padding: 8px;
        }
        .btn-custom {
            width: 100%;
            justify-content: center;
            padding: 10px 15px;
            font-size: 0.75rem;
        }
        .ticket-card {
            padding: 15px;
        }
    }

    @media (max-width: 575.98px) {
        .d-flex.align-items-start {
            flex-direction: column;
            gap: 12px;
        }
        .booking-card img {
            width: 70px !important;
            height: 70px !important;
        }
        .btn-action-group {
            padding: 8px;
        }
        .btn-custom {
            font-size: 0.7rem;
            padding: 8px 12px;
        }
        .btn-custom i {
            font-size: 0.8rem;
        }
        .nav-pills .nav-link {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        .ticket-card {
            padding: 12px;
            margin-bottom: 10px;
        }
        .ticket-card h6 {
            font-size: 0.9rem;
        }
        .ticket-card p {
            font-size: 0.8rem;
        }
        .modal-body {
            padding: 16px !important;
        }
        .modal-header, .modal-footer {
            padding: 12px 16px !important;
        }
        .form-control {
            font-size: 16px;
        }
    }
</style>

<div class="content-wrapper">
    <div class="container mt-4" style="min-height: 80vh;">
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-0" style="font-family: 'Cinzel'; color: #1a1a1a;">My Bookings</h2>
                <p class="text-muted small mb-0">Manage your stays and support tickets</p>
            </div>
            
            <!-- Tabs -->
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-bookings-tab" data-bs-toggle="pill" data-bs-target="#pills-bookings" type="button">
                        <i class="bi bi-calendar-check me-2"></i> Bookings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-issues-tab" data-bs-toggle="pill" data-bs-target="#pills-issues" type="button">
                        <i class="bi bi-tools me-2"></i> Support
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            
            <!-- TAB 1: BOOKINGS -->
            <div class="tab-pane fade show active" id="pills-bookings">
                <div class="row g-4">
                    <% if(bookings.length > 0) { %>
                        <% bookings.forEach(row => { 
                            let statusColor = row.status === 'Approved' ? 'status-approved' : (row.status === 'Pending' ? 'status-pending' : 'status-rejected');
                            let badgeColor = row.status === 'Approved' ? 'bg-success' : (row.status === 'Pending' ? 'bg-warning text-dark' : 'bg-danger');
                        %>
                        <div class="col-lg-6">
                            <div class="booking-card">
                                <div class="booking-status-bar <%= statusColor %>"></div>
                                <div class="p-4">
                                    <div class="d-flex align-items-start">
                                        <% if(row.image) { %>
                                            <img src="/uploads/<%= row.image %>"
                                        <% } else { %>
                                            <div class="placeholder-img placeholder-hostel" style="width:80px;height:80px;"></div>
                                        <% } %>
                                        <% if(row.image) { %>
                                            <img src="/uploads/<%= row.image %>" 
                                             class="rounded-3 shadow-sm me-3" style="width:80px; height:80px; object-fit:cover;">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <h5 class="fw-bold mb-1"><%= row.name %></h5>
                                                <span class="badge <%= badgeColor %> rounded-pill"><%= row.status %></span>
                                            </div>
                                            <p class="text-muted small mb-1"><i class="bi bi-geo-alt text-gold"></i> <%= row.area %></p>
                                            <h6 class="text-success fw-bold">Rs. <%= row.price.toLocaleString() %> <span class="text-muted small fw-normal">/month</span></h6>
                                        </div>
                                    </div>

                                    <hr class="my-3 opacity-10">

                                    <div class="btn-action-group">
                                        <!-- Report Issue -->
                                        <button class="btn-custom btn-light text-danger border-0" onclick="openComplaint('<%= row.hostel_id %>')">
                                            <i class="bi bi-exclamation-circle-fill"></i> Report
                                        </button>

                                        <!-- Payment Logic -->
                                        <% if (row.status === 'Approved') { %>
                                            <% if (row.payment_proof) { %>
                                                <span class="d-flex align-items-center text-success small fw-bold me-2"><i class="bi bi-check-circle-fill me-1"></i> Paid</span>
                                                <a href="/receipt/<%= row.id %>" target="_blank" class="btn-custom btn-dark text-gold" style="border: 1px solid #D4AF37;">
                                                    <i class="bi bi-receipt"></i> Receipt
                                                </a>
                                            <% } else { %>
                                                <button type="button" class="btn-custom btn-warning fw-bold" 
                                                        data-id="<%= row.id %>"
                                                        data-jcname="<%= row.jazzcash_name || '' %>" 
                                                        data-jcno="<%= row.jazzcash_no || '' %>"
                                                        data-epname="<%= row.easypaisa_name || '' %>"
                                                        data-epno="<%= row.easypaisa_no || '' %>"
                                                        data-bankname="<%= row.bank_name || '' %>"
                                                        data-banktitle="<%= row.bank_acc_title || '' %>"
                                                        data-bankiban="<%= row.bank_iban || '' %>"
                                                        onclick="showPaymentModal(this)">
                                                    <i class="bi bi-upload"></i> Pay Rent
                                                </button>
                                            <% } %>
                                        <% } else { %>
                                            <span class="small text-muted my-auto">Awaiting Approval</span>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12 text-center py-5">
                            <div class="mb-3"><i class="bi bi-journal-x display-1 text-muted opacity-25"></i></div>
                            <h4 class="text-muted">No bookings found.</h4>
                            <a href="/" class="btn btn-outline-dark mt-3 rounded-pill px-4">Browse Hostels</a>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- TAB 2: COMPLAINTS -->
            <div class="tab-pane fade" id="pills-issues">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <% if (typeof complaints !== 'undefined' && complaints.length > 0) { %>
                            <% complaints.forEach(c => { 
                                let ticketClass = c.status === 'Resolved' ? 'resolved' : 'pending';
                                let statusIcon = c.status === 'Resolved' ? 'bi-check-circle-fill text-success' : 'bi-hourglass-split text-danger';
                            %>
                            <div class="ticket-card <%= ticketClass %>">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="fw-bold mb-1 text-dark"><i class="bi bi-ticket-detailed me-2 text-muted"></i> <%= c.issue_type %></h6>
                                        <p class="text-muted small mb-2"><%= c.description %></p>
                                        <small class="text-secondary"><i class="bi bi-clock"></i> <%= new Date(c.created_at).toLocaleDateString() %></small>
                                    </div>
                                    <div class="text-end">
                                        <span class="d-block fs-4"><i class="<%= statusIcon %>"></i></span>
                                        <small class="fw-bold <%= c.status === 'Resolved' ? 'text-success' : 'text-danger' %>"><%= c.status %></small>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="bi bi-emoji-smile display-4 text-success opacity-50"></i>
                                <p class="mt-3 text-muted">No issues reported. Great!</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- 1. COMPLAINT MODAL -->
<div class="modal fade" id="complaintModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/submit_complaint" method="POST" class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-tools"></i> Report Issue</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="hostel_id" id="comp_hid">
                <label class="fw-bold mb-2 text-secondary">What's wrong?</label>
                <div class="d-flex gap-2 mb-3 flex-wrap">
                    <input type="radio" class="btn-check" name="issue" id="i1" value="Electricity" checked>
                    <label class="btn btn-outline-dark rounded-pill btn-sm" for="i1">Electricity</label>

                    <input type="radio" class="btn-check" name="issue" id="i2" value="WiFi">
                    <label class="btn btn-outline-dark rounded-pill btn-sm" for="i2">WiFi</label>

                    <input type="radio" class="btn-check" name="issue" id="i3" value="Plumbing">
                    <label class="btn btn-outline-dark rounded-pill btn-sm" for="i3">Water</label>

                    <input type="radio" class="btn-check" name="issue" id="i4" value="Cleanliness">
                    <label class="btn btn-outline-dark rounded-pill btn-sm" for="i4">Cleaning</label>
                </div>
                <label class="fw-bold mb-2 text-secondary">Details</label>
                <textarea name="desc" class="form-control bg-light" rows="3" placeholder="Describe the issue..." required></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-danger w-100 rounded-pill">Submit Report</button>
            </div>
        </form>
    </div>
</div>

<!-- 2. PAYMENT UPLOAD MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/upload_payment" method="POST" enctype="multipart/form-data" class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white border-0">
                <h5 class="modal-title" style="color: #D4AF37;">Make Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <!-- DYNAMIC DETAILS -->
                <div id="paymentDetailsBox" class="mb-4 bg-light p-3 rounded text-center border border-dashed">
                    <p class="text-muted small mb-0">Loading payment details...</p>
                </div>

                <div class="text-center">
                    <small class="text-muted d-block mb-2 fw-bold text-uppercase ls-1">Upload Receipt</small>
                    <input type="hidden" name="booking_id" id="modal_booking_id">
                    <input type="file" name="proof" class="form-control" required accept="image/*">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-gold fw-bold w-100 rounded-pill">Confirm Payment</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function openComplaint(hostelId) {
        document.getElementById('comp_hid').value = hostelId;
        var myModal = new bootstrap.Modal(document.getElementById('complaintModal'));
        myModal.show();
    }

    function showPaymentModal(btn) {
        const id = btn.getAttribute('data-id');
        const jcName = btn.getAttribute('data-jcname');
        const jcNo = btn.getAttribute('data-jcno');
        const epName = btn.getAttribute('data-epname');
        const epNo = btn.getAttribute('data-epno');
        const bankName = btn.getAttribute('data-bankname');
        const bankTitle = btn.getAttribute('data-banktitle');
        const bankIban = btn.getAttribute('data-bankiban');

        let html = '<p class="small text-center mb-3 text-muted">Transfer rent to one of these accounts:</p>';
        let hasMethod = false;

        if(jcNo && jcNo !== "null") {
            html += `<div class="alert alert-danger py-2 mb-2 d-flex align-items-center"><i class="bi bi-phone fs-4 me-3"></i><div class="text-start"><strong>JazzCash</strong><br><span class="small">${jcNo} (${jcName})</span></div></div>`;
            hasMethod = true;
        }
        if(epNo && epNo !== "null") {
            html += `<div class="alert alert-success py-2 mb-2 d-flex align-items-center"><i class="bi bi-wallet2 fs-4 me-3"></i><div class="text-start"><strong>EasyPaisa</strong><br><span class="small">${epNo} (${epName})</span></div></div>`;
            hasMethod = true;
        }
        if(bankIban && bankIban !== "null") {
            html += `<div class="alert alert-primary py-2 mb-2 d-flex align-items-center"><i class="bi bi-bank fs-4 me-3"></i><div class="text-start"><strong>${bankName}</strong><br><span class="small">${bankIban}<br>${bankTitle}</span></div></div>`;
            hasMethod = true;
        }

        if(!hasMethod) html = '<div class="alert alert-warning text-center">Owner has not provided payment details.<br>Please chat with them directly.</div>';

        document.getElementById('paymentDetailsBox').innerHTML = html;
        document.getElementById('modal_booking_id').value = id;

        var modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
    }
</script>

<%- include('partials/footer') %>